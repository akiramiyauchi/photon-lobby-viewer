<script>
    function formatTimestamp(timestamp) {
        if (!timestamp) return "Unknown time";

        // Firestore の Timestamp 型対応
        if (timestamp.seconds) {
            return new Date(timestamp.seconds * 1000).toLocaleString();
        }

        // 文字列の Timestamp も対応
        const date = new Date(timestamp);
        return isNaN(date.getTime()) ? "Invalid Date" : date.toLocaleString();
    }

    async function fetchRoomUpdates() {
        try {
            const response = await fetch('/.netlify/functions/getRoomUpdates');

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();

            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            if (data.length === 0) {
                playerList.innerHTML = '<li>現在、ロビーにプレイヤーはいません。</li>';
                return;
            }

            data.forEach(item => {
                const listItem = document.createElement('li');
                listItem.textContent = `Player ${item.player} ${item.status} at ${formatTimestamp(item.timestamp)}`;
                playerList.appendChild(listItem);
            });
        } catch (error) {
            console.error("Error fetching room updates:", error);
            document.getElementById('errorMessage').textContent = "データの取得に失敗しました。";
        }
    }

    setInterval(fetchRoomUpdates, 3000);
</script>
